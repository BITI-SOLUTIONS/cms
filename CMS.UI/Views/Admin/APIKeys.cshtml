@* ================================================================================ *@
@* ARCHIVO: CMS.UI/Views/Admin/APIKeys.cshtml                                       *@
@* PROPÓSITO: Vista de gestión de API Keys                                          *@
@* AUTOR: EAMR, BITI SOLUTIONS S.A                                                  *@
@* ================================================================================ *@

@model CMS.UI.Models.Admin.ApiKeysViewModel

@{
    ViewData["Title"] = "API Keys";
}

<div class="content-container">
    <!-- Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-icon bg-gradient-yellow">
                <i class="bi bi-key-fill"></i>
            </div>
            <div class="page-header-text">
                <h1>API Keys</h1>
                <p>Gestionar claves de acceso para integraciones externas</p>
            </div>
        </div>
        <div class="page-header-actions">
            <button class="btn btn-tech-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
                <i class="bi bi-plus-lg me-2"></i>Nueva API Key
            </button>
        </div>
    </div>

    <!-- Alerta de nueva key -->
    @if (TempData["NewApiKey"] != null)
    {
        <div class="alert-new-key mb-4">
            <div class="alert-new-key-icon">
                <i class="bi bi-key-fill"></i>
            </div>
            <div class="alert-new-key-content">
                <h5>¡API Key creada exitosamente!</h5>
                <p>Copia esta clave ahora. No podrás verla de nuevo.</p>
                <div class="key-display">
                    <code id="newKeyCode">@TempData["NewApiKey"]</code>
                    <button class="btn-copy" onclick="copyKey()">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </div>
            </div>
        </div>
    }

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success-tech d-flex align-items-center mb-4">
            <i class="bi bi-check-circle-fill me-2"></i>
            <div>@TempData["Success"]</div>
            <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Lista de API Keys -->
    <div class="card-tech">
        <div class="card-header-tech">
            <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>API Keys Registradas</h5>
        </div>
        <div class="card-body p-0">
            @if (!Model.ApiKeys.Any())
            {
                <div class="empty-state py-5">
                    <i class="bi bi-key" style="font-size: 3rem; color: var(--accent-cyan);"></i>
                    <h5 class="mt-3">No hay API Keys</h5>
                    <p class="text-muted-tech">Crea tu primera API Key para integraciones</p>
                </div>
            }
            else
            {
                <div class="api-keys-grid">
                    @foreach (var key in Model.ApiKeys)
                    {
                        <div class="api-key-card @(!key.IsActive ? "inactive" : "")">
                            <div class="api-key-header">
                                <div class="api-key-name">
                                    <i class="bi bi-key me-2"></i>@key.Name
                                </div>
                                <span class="env-badge env-@key.Environment.ToLower()">@key.Environment</span>
                            </div>
                            <div class="api-key-prefix">
                                <code>@key.KeyPrefix</code>
                            </div>
                            <div class="api-key-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Creada</span>
                                    <span class="meta-value">@key.CreatedAt.ToString("dd/MM/yyyy")</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Último uso</span>
                                    <span class="meta-value">
                                        @(key.LastUsed?.ToString("dd/MM/yyyy HH:mm") ?? "Nunca")
                                    </span>
                                </div>
                            </div>
                            <div class="api-key-permissions">
                                @foreach (var perm in key.Permissions.Take(3))
                                {
                                    <span class="perm-tag">@perm</span>
                                }
                                @if (key.Permissions.Length > 3)
                                {
                                    <span class="perm-more">+@(key.Permissions.Length - 3)</span>
                                }
                            </div>
                            <div class="api-key-actions">
                                @if (key.IsActive)
                                {
                                    <span class="status-badge status-active">
                                        <i class="bi bi-check-circle me-1"></i>Activa
                                    </span>
                                    <form asp-action="RevokeApiKey" asp-route-id="@key.Id" method="post" style="display: inline;">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn-action-revoke" 
                                                onclick="return confirm('¿Revocar esta API Key? Las integraciones que la usen dejarán de funcionar.')">
                                            <i class="bi bi-x-circle me-1"></i>Revocar
                                        </button>
                                    </form>
                                }
                                else
                                {
                                    <span class="status-badge status-revoked">
                                        <i class="bi bi-x-circle me-1"></i>Revocada
                                    </span>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Documentación -->
    <div class="card-tech mt-4">
        <div class="card-header-tech">
            <h5 class="mb-0"><i class="bi bi-book me-2"></i>Uso de API Keys</h5>
        </div>
        <div class="card-body">
            <p class="text-muted-tech mb-3">Incluye tu API Key en el header de cada solicitud:</p>
            <pre class="code-block"><code>curl -X GET "https://api.biti-solutions.com/v1/resource" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json"</code></pre>
        </div>
    </div>
</div>

<!-- Modal Crear API Key -->
<div class="modal fade" id="createKeyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: #1e293b; border: 1px solid rgba(6,182,212,0.3); border-radius: 16px;">
            <form asp-action="CreateApiKey" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header" style="border-bottom: 1px solid rgba(6,182,212,0.2);">
                    <h5 class="modal-title" style="color: #f8fafc;">
                        <i class="bi bi-plus-circle me-2" style="color: #06b6d4;"></i>
                        Crear Nueva API Key
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 1.5rem;">
                    <div class="mb-3">
                        <label class="form-label-tech">Nombre <span class="text-danger">*</span></label>
                        <input type="text" name="Name" class="form-control-tech" 
                               placeholder="Ej: Mobile App Production" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label-tech">Ambiente</label>
                        <select name="Environment" class="form-select-tech">
                            <option value="Production">Production</option>
                            <option value="Development">Development</option>
                            <option value="Staging">Staging</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label-tech">Permisos</label>
                        <div class="permissions-grid">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="Permissions" value="read:all" />
                                <span>read:all</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="Permissions" value="write:all" />
                                <span>write:all</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="Permissions" value="read:users" checked />
                                <span>read:users</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="Permissions" value="write:users" />
                                <span>write:users</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(6,182,212,0.2);">
                    <button type="button" class="btn btn-tech-outline" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-tech-primary">
                        <i class="bi bi-key me-2"></i>Crear API Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .bg-gradient-yellow {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }

    .alert-new-key {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }

    .alert-new-key-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: rgba(16, 185, 129, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #10b981;
    }

    .alert-new-key h5 {
        color: #10b981;
        margin: 0 0 5px 0;
    }

    .alert-new-key p {
        color: var(--text-gray);
        margin: 0 0 15px 0;
        font-size: 0.9rem;
    }

    .key-display {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 15px;
        border-radius: 8px;
    }

    .key-display code {
        color: #22d3ee;
        font-size: 0.9rem;
        flex: 1;
    }

    .btn-copy {
        background: rgba(6, 182, 212, 0.2);
        border: none;
        color: #06b6d4;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
    }

    .api-keys-grid {
        display: grid;
        gap: 1rem;
        padding: 1.5rem;
    }

    .api-key-card {
        background: var(--bg-dark);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.2s;
    }

    .api-key-card:hover {
        border-color: rgba(6, 182, 212, 0.3);
    }

    .api-key-card.inactive {
        opacity: 0.6;
    }

    .api-key-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .api-key-name {
        color: var(--text-white);
        font-weight: 600;
    }

    .env-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .env-production { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .env-development { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .env-staging { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

    .api-key-prefix code {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px 12px;
        border-radius: 6px;
        display: block;
        color: var(--text-gray);
        font-size: 0.85rem;
    }

    .api-key-meta {
        display: flex;
        gap: 20px;
        margin: 12px 0;
    }

    .meta-item {
        display: flex;
        flex-direction: column;
    }

    .meta-label {
        font-size: 0.7rem;
        color: var(--text-gray);
        text-transform: uppercase;
    }

    .meta-value {
        color: var(--text-white);
        font-size: 0.85rem;
    }

    .api-key-permissions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
    }

    .perm-tag {
        background: rgba(139, 92, 246, 0.15);
        color: #a78bfa;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    .perm-more {
        background: rgba(6, 182, 212, 0.15);
        color: #06b6d4;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
    }

    .api-key-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid var(--border-color);
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .status-active { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-revoked { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

    .btn-action-revoke {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #ef4444;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-action-revoke:hover {
        background: rgba(239, 68, 68, 0.2);
    }

    .code-block {
        background: #0d1117;
        border-radius: 8px;
        padding: 15px;
        overflow-x: auto;
    }

    .code-block code {
        color: #22d3ee;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
    }

    .permissions-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .perm-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--bg-dark);
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-gray);
        font-size: 0.85rem;
    }

    .perm-checkbox input:checked + span {
        color: #a78bfa;
    }
</style>

<script>
    function copyKey() {
        var code = document.getElementById('newKeyCode').textContent;
        navigator.clipboard.writeText(code);
        alert('API Key copiada al portapapeles');
    }
</script>
