@* ================================================================================ *@
@* ARCHIVO: CMS.UI/Views/Shared/Components/Menu/Default.cshtml                     *@
@* PROPÓSITO: Vista del ViewComponent para renderizar el menú de navegación        *@
@* DESCRIPCIÓN: Renderiza el menú jerárquico con dos niveles (padre e hijos)      *@
@*              Resalta el menú activo según la URL actual y mantiene expandidos   *@
@*              los grupos que contienen la página activa.                         *@
@* ================================================================================ *@

@using CMS.Application.DTOs
@model List<MenuDto>

@{
    // Obtener la ruta actual para determinar qué menú está activo
    var currentPath = Context.Request.Path.Value?.ToLower() ?? "";
}

@* Recorrer todos los menús de nivel raíz (ParentId == 0) *@
@foreach (var parent in Model.Where(m => m.IdParent == 0))
{
    // Obtener los menús hijos de este padre
    var children = Model
        .Where(m => m.IdParent == parent.IdMenu)
        .OrderBy(m => m.Order)
        .ToList();

    // Determinar si este grupo debe estar expandido (open)
    // Se expande si algún hijo está activo o si el padre está activo
    bool isOpen =
        children.Any(c => currentPath.StartsWith(c.Url.ToLower())) ||
        currentPath.StartsWith(parent.Url.ToLower());

    @* Si el menú tiene hijos, renderizar como grupo expandible *@
    if (children.Any())
    {
        <li class="nav-item nav-group @(isOpen ? "open" : "")">
            @* Toggle del grupo (menú padre con hijos) *@
            <a class="nav-link nav-group-toggle" href="javascript:void(0)">
                @if (!string.IsNullOrEmpty(parent.Icon))
                {
                    <i class="@parent.Icon"></i>
                }
                <span>@parent.Name</span>
                <i class="bi bi-chevron-down ms-auto"></i>
            </a>

            @* Lista de menús hijos *@
            <ul class="nav nav-group-items">
                @foreach (var child in children)
                {
                    // Determinar si este hijo está activo
                    bool isActive = currentPath.StartsWith(child.Url.ToLower());

                    <li class="nav-item">
                        <a class="nav-link @(isActive ? "active" : "")" href="@child.Url">
                            @if (!string.IsNullOrEmpty(child.Icon))
                            {
                                <i class="@child.Icon"></i>
                            }
                            <span>@child.Name</span>
                        </a>
                    </li>
                }
            </ul>
        </li>
    }
    else
    {
        @* Menú de nivel raíz sin hijos (menú simple) *@
        bool isActive = currentPath.StartsWith(parent.Url.ToLower());

        <li class="nav-item">
            <a class="nav-link @(isActive ? "active" : "")" href="@parent.Url">
                @if (!string.IsNullOrEmpty(parent.Icon))
                {
                    <i class="@parent.Icon"></i>
                }
                <span>@parent.Name</span>
            </a>
        </li>
    }
}