@* ================================================================================ *@
@* ARCHIVO: CMS.UI/Views/Users/Edit.cshtml                                          *@
@* PROPÓSITO: Formulario para editar un usuario existente                           *@
@* AUTOR: EAMR, BITI SOLUTIONS S.A                                                  *@
@* CREADO: 2026-02-14                                                               *@
@* ================================================================================ *@

@model CMS.UI.Models.Users.UserEditViewModel

@{
    ViewData["Title"] = $"Editar Usuario: {Model.Username}";
}

<div class="content-container">
    <!-- ===== HEADER ===== -->
    <div class="page-header mb-4">
        <div class="page-header-content">
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn-back me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div class="page-header-icon bg-gradient-orange">
                <i class="bi bi-pencil-square"></i>
            </div>
            <div class="page-header-text">
                <h1>Editar Usuario</h1>
                <p>@@@Model.Username - @Model.Email</p>
            </div>
        </div>
    </div>

    <form asp-action="Edit" method="post" id="editUserForm">
        <input type="hidden" asp-for="Id" />
        
        <div class="row">
            <!-- ===== FORMULARIO PRINCIPAL ===== -->
            <div class="col-lg-8">
                <!-- Información de Cuenta -->
                <div class="card-tech mb-4">
                    <div class="card-header-tech">
                        <h5><i class="bi bi-key me-2"></i>Información de Cuenta</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="Username" class="form-label-tech">
                                    Nombre de Usuario
                                </label>
                                <div class="input-group-tech">
                                    <span class="input-icon"><i class="bi bi-at"></i></span>
                                    <input asp-for="Username" class="form-control-tech" readonly disabled 
                                           style="opacity: 0.6;" />
                                </div>
                                <small class="form-text-tech">El nombre de usuario no se puede cambiar</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label-tech">
                                    Correo Electrónico <span class="required">*</span>
                                </label>
                                <div class="input-group-tech">
                                    <span class="input-icon"><i class="bi bi-envelope"></i></span>
                                    <input asp-for="Email" type="email" class="form-control-tech" />
                                </div>
                                <span asp-validation-for="Email" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información Personal -->
                <div class="card-tech mb-4">
                    <div class="card-header-tech">
                        <h5><i class="bi bi-person-vcard me-2"></i>Información Personal</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label-tech">
                                    Nombre <span class="required">*</span>
                                </label>
                                <input asp-for="FirstName" class="form-control-tech" />
                                <span asp-validation-for="FirstName" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label-tech">
                                    Apellido <span class="required">*</span>
                                </label>
                                <input asp-for="LastName" class="form-control-tech" />
                                <span asp-validation-for="LastName" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="DisplayName" class="form-label-tech">
                                    Nombre para Mostrar
                                </label>
                                <input asp-for="DisplayName" class="form-control-tech" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="PhoneNumber" class="form-label-tech">
                                    Teléfono
                                </label>
                                <div class="input-group-tech">
                                    <span class="input-icon"><i class="bi bi-telephone"></i></span>
                                    <input asp-for="PhoneNumber" class="form-control-tech" />
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="DateOfBirth" class="form-label-tech">
                                    Fecha de Nacimiento
                                </label>
                                <input asp-for="DateOfBirth" type="date" class="form-control-tech" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="IdCountry" class="form-label-tech">
                                    País <span class="required">*</span>
                                </label>
                                <select asp-for="IdCountry" asp-items="Model.AvailableCountries" class="form-select-tech">
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label asp-for="IdGender" class="form-label-tech">
                                    Género <span class="required">*</span>
                                </label>
                                <select asp-for="IdGender" asp-items="Model.AvailableGenders" class="form-select-tech">
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="TimeZone" class="form-label-tech">
                                    Zona Horaria
                                </label>
                                <select asp-for="TimeZone" class="form-select-tech">
                                    <option value="America/Costa_Rica">Costa Rica (UTC-6)</option>
                                    <option value="America/Mexico_City">México (UTC-6)</option>
                                    <option value="America/New_York">Nueva York (UTC-5)</option>
                                    <option value="America/Los_Angeles">Los Ángeles (UTC-8)</option>
                                    <option value="Europe/Madrid">Madrid (UTC+1)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== PANEL LATERAL ===== -->
            <div class="col-lg-4">
                <!-- Estado y Opciones -->
                <div class="card-tech mb-4">
                    <div class="card-header-tech">
                        <h5><i class="bi bi-gear me-2"></i>Estado de la Cuenta</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check-tech mb-3">
                            <input asp-for="IsActive" type="checkbox" class="form-check-input-tech" id="isActive" />
                            <label for="isActive" class="form-check-label-tech">
                                <i class="bi bi-check-circle me-2"></i>Usuario Activo
                            </label>
                            <small class="form-text-tech d-block">El usuario podrá acceder al sistema</small>
                        </div>
                        <div class="form-check-tech">
                            <input asp-for="IsEmailVerified" type="checkbox" class="form-check-input-tech" id="isEmailVerified" />
                            <label for="isEmailVerified" class="form-check-label-tech">
                                <i class="bi bi-envelope-check me-2"></i>Email Verificado
                            </label>
                            <small class="form-text-tech d-block">Marcar email como verificado</small>
                        </div>
                    </div>
                </div>

                <!-- Roles -->
                <div class="card-tech mb-4">
                    <div class="card-header-tech d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-shield me-2"></i>Roles Asignados</h5>
                        <button type="button" class="btn btn-sm btn-tech-success" id="btnSaveRoles" title="Guardar roles">
                            <i class="bi bi-check-lg me-1"></i>Guardar Roles
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="search-box mb-3">
                            <input type="text" class="form-control-tech" id="searchRoles" placeholder="🔍 Buscar roles...">
                        </div>
                        @if (Model.AvailableRoles.Any())
                        {
                            <div class="roles-selector" id="rolesContainer">
                                @foreach (var role in Model.AvailableRoles)
                                {
                                    var isChecked = Model.SelectedRoleIds.Contains(int.Parse(role.Value));
                                    <div class="role-checkbox @(isChecked ? "selected" : "")" data-name="@role.Text.ToLower()">
                                        <input type="checkbox" name="SelectedRoleIds" value="@role.Value" 
                                               id="role_@role.Value" class="form-check-input-tech role-check"
                                               @(isChecked ? "checked" : "") />
                                        <label for="role_@role.Value" class="role-label">
                                            <i class="bi bi-shield-check me-2"></i>@role.Text
                                        </label>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted-tech">No hay roles disponibles</p>
                        }
                    </div>
                </div>

                <!-- Compañías -->
                <div class="card-tech mb-4">
                    <div class="card-header-tech d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-building me-2"></i>Compañías Asignadas</h5>
                        <button type="button" class="btn btn-sm btn-tech-success" id="btnSaveCompanies" title="Guardar compañías">
                            <i class="bi bi-check-lg me-1"></i>Guardar Compañías
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="search-box mb-3">
                            <input type="text" class="form-control-tech" id="searchCompanies" placeholder="🔍 Buscar compañías...">
                        </div>
                        @if (Model.AvailableCompanies.Any())
                        {
                            <div class="roles-selector" id="companiesContainer">
                                @foreach (var company in Model.AvailableCompanies)
                                {
                                    var isChecked = Model.SelectedCompanyIds.Contains(int.Parse(company.Value));
                                    <div class="role-checkbox @(isChecked ? "selected" : "")" data-name="@company.Text.ToLower()">
                                        <input type="checkbox" name="SelectedCompanyIds" value="@company.Value" 
                                               id="company_@company.Value" class="form-check-input-tech company-check"
                                               @(isChecked ? "checked" : "") />
                                        <label for="company_@company.Value" class="role-label">
                                            <i class="bi bi-building me-2"></i>@company.Text
                                        </label>
                                    </div>
                                }
                            </div>
                            <div class="alert alert-warning-tech mt-3" style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 8px; padding: 12px;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Importante:</strong> El usuario debe tener al menos una compañía asignada para poder iniciar sesión.
                            </div>
                        }
                        else
                        {
                            <p class="text-muted-tech">No hay compañías disponibles</p>
                        }
                    </div>
                </div>

                <!-- Seguridad -->
                <div class="card-tech mb-4">
                    <div class="card-header-tech">
                        <h5><i class="bi bi-shield-lock me-2"></i>Seguridad</h5>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-tech-outline w-100" id="btnResetPassword">
                            <i class="bi bi-key me-2"></i>Restablecer Contraseña
                        </button>
                        <small class="form-text-tech d-block mt-2 text-center">
                            Se enviará un email con un enlace para cambiar la contraseña
                        </small>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="card-tech">
                    <div class="card-body">
                        <button type="submit" class="btn btn-tech-primary w-100 mb-2">
                            <i class="bi bi-check-lg me-2"></i>Guardar Cambios
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-tech-outline w-100">
                            <i class="bi bi-x-lg me-2"></i>Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Formulario de Reset Password (FUERA del formulario principal) -->
    <form asp-action="ResetPassword" asp-route-id="@Model.Id" method="post" id="resetPasswordForm" style="display:none;">
        @Html.AntiForgeryToken()
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        const userId = @Model.Id;

        // Reset Password
        document.getElementById('btnResetPassword').addEventListener('click', function() {
            if (confirm('¿Enviar email de restablecimiento de contraseña al usuario?')) {
                document.getElementById('resetPasswordForm').submit();
            }
        });

        // Búsqueda de roles
        document.getElementById('searchRoles').addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            document.querySelectorAll('#rolesContainer .role-checkbox').forEach(item => {
                const name = item.dataset.name;
                item.style.display = name.includes(filter) ? 'flex' : 'none';
            });
        });

        // Búsqueda de compañías
        document.getElementById('searchCompanies').addEventListener('input', function() {
            const filter = this.value.toLowerCase();
            document.querySelectorAll('#companiesContainer .role-checkbox').forEach(item => {
                const name = item.dataset.name;
                item.style.display = name.includes(filter) ? 'flex' : 'none';
            });
        });

        // Toggle visual de checkboxes
        document.querySelectorAll('.role-checkbox input').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                this.closest('.role-checkbox').classList.toggle('selected', this.checked);
            });
        });

        // Guardar Roles vía AJAX
        document.getElementById('btnSaveRoles').addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
            btn.disabled = true;

            const roleIds = Array.from(document.querySelectorAll('.role-check:checked'))
                                 .map(cb => parseInt(cb.value));

            try {
                const response = await fetch('/Admin/Users/AssignRoles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId: userId, roleIds: roleIds })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('✅ Roles guardados exitosamente', 'success');
                } else {
                    showToast('❌ ' + (result.message || 'Error al guardar roles'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('❌ Error de conexión', 'error');
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });

        // Guardar Compañías vía AJAX
        document.getElementById('btnSaveCompanies').addEventListener('click', async function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Guardando...';
            btn.disabled = true;

            const companyIds = Array.from(document.querySelectorAll('.company-check:checked'))
                                    .map(cb => parseInt(cb.value));

            try {
                const response = await fetch('/Admin/Users/AssignCompanies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId: userId, companyIds: companyIds })
                });

                const result = await response.json();

                if (result.success) {
                    showToast('✅ Compañías guardadas exitosamente', 'success');
                } else {
                    showToast('❌ ' + (result.message || 'Error al guardar compañías'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('❌ Error de conexión', 'error');
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });

        // Función para mostrar toast
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
}

<style>
    .required {
        color: #ef4444;
    }

    .btn-back {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(6, 182, 212, 0.1);
        border: 1px solid var(--border-color);
        color: var(--accent-cyan);
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-back:hover {
        background: rgba(6, 182, 212, 0.2);
        color: var(--accent-cyan);
    }

    .bg-gradient-orange {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
    }

    .form-check-tech {
        padding: 12px;
        background: rgba(6, 182, 212, 0.05);
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }

    .form-check-input-tech {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        background: var(--bg-dark);
        border: 2px solid var(--border-color);
        border-radius: 4px;
    }

    .form-check-input-tech:checked {
        background: var(--accent-cyan);
        border-color: var(--accent-cyan);
    }

    .form-check-label-tech {
        color: var(--text-white);
        font-weight: 500;
    }

    .roles-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .role-checkbox {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(139, 92, 246, 0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .role-checkbox:hover {
        border-color: rgba(139, 92, 246, 0.3);
        background: rgba(139, 92, 246, 0.1);
    }

    .role-checkbox.selected {
        border-color: rgba(139, 92, 246, 0.5);
        background: rgba(139, 92, 246, 0.15);
    }

    .role-checkbox input:checked + .role-label {
        color: #a78bfa;
    }

    .role-label {
        color: var(--text-gray);
        cursor: pointer;
        margin: 0;
    }

    .form-text-tech {
        color: var(--text-gray);
        font-size: 0.8rem;
        margin-top: 4px;
    }
</style>
