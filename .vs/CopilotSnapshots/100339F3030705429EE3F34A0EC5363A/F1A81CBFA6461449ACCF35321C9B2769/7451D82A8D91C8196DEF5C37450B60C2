# Copilot Instructions

## Project Guidelines
- Proyecto CMS de BITI Solutions S.A - Arquitectura Clean Architecture con capas: CMS.API (Web API REST), CMS.Application (CQRS/MediatR), CMS.Data (Repository/EF Core), CMS.Entities (Domain), CMS.UI (Razor Pages/MVC), CMS.Shared (Infraestructura compartida)
- Stack tecnológico CMS: .NET 9.0 (C# 13), PostgreSQL 15 (Alpine), Kubernetes k3s, Azure AD (Entra ID) para autenticación, Entity Framework Core 9.0 con Npgsql, Docker + Harbor registry privado.
- Puertos CMS: API interno 8080 (externo 5000 dev), UI interno 8081 (externo 3000 dev), PostgreSQL 5432 (NodePort 30432). 
- Servidor: BITISERVER1 @ 147.182.204.86 (DigitalOcean). 
- Dominio: cms.biti-solutions.com. 
- Registry: registry.biti-solutions.com.
- Base de datos CMS: PostgreSQL 15, esquema principal "admin" (ej: admin.menu). Usuario: cmssystem. Credenciales en Kubernetes Secret cms-db-secret.
- **Configuración**: El proyecto CMS NO usa `appsettings.json`. Usa `connectionstrings.json` para TODA la configuración (connection strings, Azure AD, etc). Ubicación: `CMS.API/connectionstrings.json` y `CMS.UI/connectionstrings.json` (mismo contenido). Está en `.gitignore`. En Kubernetes se monta desde ConfigMap `cms-connectionstrings`.

## ⚠️ REGLAS CRÍTICAS - NO ROMPER ⚠️

### Sesión y Antiforgery Token (CMS.UI)
1. **NUNCA usar `HttpContext.Session.Clear()` en métodos POST con `[ValidateAntiForgeryToken]`** - Esto invalida el token y causa error 500.
2. **SelectCompany POST NO usa [ValidateAntiForgeryToken]** - Es la primera página que ve el usuario sin cookies, el token no puede validarse. Es público y seguro.
3. **En SelectCompany GET**: Solo limpiar sesión si `forceLogout=true`. Siempre inicializar la sesión con un valor dummy para asegurar que la cookie exista.
4. **Configuración de cookies de sesión**: Usar `SameSiteMode.Lax` y `SecurePolicy.SameAsRequest` en desarrollo.

### Rutas (CMS.UI)
1. **Links de navegación**: Siempre usar tag helpers (`asp-controller`, `asp-action`) en lugar de URLs hardcodeadas.
2. **Ruta para /Home**: Debe existir una ruta específica que mapee `/Home` a `Home/Index`.

## Branching and Commit Conventions
- Convenciones de branches CMS: main (producción), develop (desarrollo), feature/[nombre], fix/[nombre], hotfix/[nombre]. 
- Commits: Conventional Commits (feat:, fix:, docs:, test:, refactor:, chore:, ci:, perf:)

## Timezone and Working Hours
- Timezone BITI Solutions: UTC-6 (Costa Rica - CST).
- Horario: 8:00 AM - 12:00 AM.
- Owner: @BITI-SOLUTIONS (desarrollador único, full stack + DevOps).