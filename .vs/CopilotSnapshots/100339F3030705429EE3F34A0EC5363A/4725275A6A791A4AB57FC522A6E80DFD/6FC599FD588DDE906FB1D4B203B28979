// ================================================================================
// ARCHIVO: CMS.UI/Controllers/HomeController.cs
// PROPÓSITO: Controller principal de la interfaz web del Sistema CMS
// DESCRIPCIÓN: Maneja la página de inicio (Dashboard) con JWT autenticado
// AUTOR: EAMR, BITI SOLUTIONS S.A
// ACTUALIZADO: 2026-02-14 - Agregado filtro de validación de sesión
// ================================================================================

using CMS.UI.Filters;
using CMS.UI.Models;
using CMS.UI.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Diagnostics;
using System.Security.Claims;

namespace CMS.UI.Controllers
{
    /// <summary>
    /// Controller principal del sistema que maneja la página de inicio y errores.
    /// Requiere autenticación y sesión válida (compañía + JWT).
    /// </summary>
    [Authorize]
    [RequireValidSession] // Valida que hay compañía y JWT en sesión
    public class HomeController : Controller
    {
        private readonly MenuApiService _api;
        private readonly ILogger<HomeController> _logger;

        /// <summary>
        /// Constructor con inyección de dependencias.
        /// </summary>
        /// <param name="api">Servicio para obtener los menús desde la API REST</param>
        /// <param name="logger">Logger para registrar eventos y errores</param>
        public HomeController(MenuApiService api, ILogger<HomeController> logger)
        {
            _api = api;
            _logger = logger;
        }

        /// <summary>
        /// Acción principal que muestra el Dashboard o página de inicio del sistema.
        /// </summary>
        public async Task<IActionResult> Index()
        {
            try
            {
                // ⭐ VERIFICAR AUTENTICACIÓN
                if (User.Identity?.IsAuthenticated != true)
                {
                    _logger.LogWarning("⚠️ Usuario no autenticado. Redirigiendo a SelectCompany.");
                    return RedirectToAction("SelectCompany", "Account", new { forceLogout = true });
                }

                // ⭐ VERIFICAR QUE HAY UNA COMPAÑÍA VÁLIDA EN LA SESIÓN
                var companyId = HttpContext.Session.GetInt32("SelectedCompanyId");
                var companySchema = HttpContext.Session.GetString("SelectedCompanySchema");

                if (companyId == null || string.IsNullOrEmpty(companySchema))
                {
                    _logger.LogWarning("⚠️ Sesión sin compañía válida. Redirigiendo a SelectCompany.");
                    return RedirectToAction("SelectCompany", "Account", new { forceLogout = true });
                }

                // ⭐ VERIFICAR SI HAY JWT EN SESIÓN
                var token = HttpContext.Session.GetString("ApiToken");

                if (string.IsNullOrEmpty(token))
                {
                    _logger.LogWarning("⚠️ No hay JWT en sesión. Redirigiendo a SelectCompany.");
                    return RedirectToAction("SelectCompany", "Account", new { forceLogout = true });
                }

                // ⭐ Obtener información del usuario autenticado
                var userEmail = User.FindFirstValue(ClaimTypes.Email)
                    ?? User.FindFirstValue("preferred_username")
                    ?? "Usuario desconocido";

                var displayName = User.FindFirstValue("name") 
                    ?? User.FindFirstValue("display_name")
                    ?? userEmail;

                // Obtener menús desde la API (con JWT en el header via AuthenticatedApiMessageHandler)
                var menus = await _api.GetMenusAsync();

                // Pasar datos a la vista
                ViewData["UserName"] = displayName;
                ViewData["UserEmail"] = userEmail;

                // Log informativo para debugging
                _logger.LogInformation(
                    "Usuario {User} accedió al Dashboard con {MenuCount} menús disponibles",
                    userEmail,
                    menus?.Count ?? 0
                );

                // Retornar vista con los menús (o lista vacía si falló la API)
                return View(menus ?? new List<CMS.Application.DTOs.MenuDto>());
            }
            catch (Exception ex)
            {
                // Log de error crítico
                _logger.LogError(ex, "Error al cargar la página de inicio para el usuario {User}",
                    User.Identity?.Name ?? "Desconocido");

                // Retornar vista con lista vacía para evitar crash
                return View(new List<CMS.Application.DTOs.MenuDto>());
            }
        }

        /// <summary>
        /// Acción que maneja los errores HTTP y excepciones no controladas del sistema.
        /// </summary>
        [AllowAnonymous] // Los errores deben mostrarse incluso sin autenticación
        [SkipSessionValidation] // No validar sesión para la página de errores
        [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
        public IActionResult Error(int? statusCode = null)
        {
            // ⭐ Verificar si hay sesión válida para decidir el layout
            var hasValidSession = HttpContext.Session.GetInt32("SelectedCompanyId") != null &&
                                  !string.IsNullOrEmpty(HttpContext.Session.GetString("ApiToken"));

            // Obtener RequestId único para correlacionar con logs
            var requestId = Activity.Current?.Id ?? HttpContext.TraceIdentifier;

            // Obtener la ruta que causó el error
            var requestPath = HttpContext.Request.Path.Value;

            // Mensaje de error según el código de estado
            string? errorMessage = statusCode switch
            {
                400 => "Solicitud inválida. Por favor, verifica los datos enviados.",
                401 => "No tiene autorización para acceder a este recurso. Inicie sesión.",
                403 => "Acceso prohibido. No tiene permisos suficientes para esta acción.",
                404 => "La página solicitada no existe o fue movida.",
                408 => "La solicitud tardó demasiado tiempo. Intente nuevamente.",
                500 => "Error interno del servidor. Nuestro equipo ha sido notificado.",
                502 => "El servidor no está disponible temporalmente. Intente más tarde.",
                503 => "Servicio no disponible. El sistema está en mantenimiento.",
                _ => statusCode.HasValue
                    ? $"Ocurrió un error inesperado (Código: {statusCode})."
                    : "Ha ocurrido un error inesperado al procesar su solicitud."
            };

            // Log del error para análisis posterior
            if (statusCode.HasValue && statusCode >= 400)
            {
                _logger.LogWarning(
                    "Error HTTP {StatusCode} en ruta {Path}. RequestId: {RequestId}. Usuario: {User}. SesiónVálida: {HasSession}",
                    statusCode,
                    requestPath,
                    requestId,
                    User.Identity?.Name ?? "Anónimo",
                    hasValidSession
                );
            }
            else
            {
                _logger.LogError(
                    "Excepción no controlada. RequestId: {RequestId}. Ruta: {Path}. Usuario: {User}",
                    requestId,
                    requestPath,
                    User.Identity?.Name ?? "Anónimo"
                );
            }

            // Crear modelo para la vista de error
            var model = new ErrorViewModel
            {
                RequestId = requestId,
                StatusCode = statusCode,
                ErrorMessage = errorMessage,
                RequestPath = requestPath
            };

            // ⭐ Si no hay sesión válida, usar vista standalone
            if (!hasValidSession)
            {
                return View("ErrorStandalone", model);
            }

            // Retornar vista de error con el modelo
            return View(model);
        }
    }
}