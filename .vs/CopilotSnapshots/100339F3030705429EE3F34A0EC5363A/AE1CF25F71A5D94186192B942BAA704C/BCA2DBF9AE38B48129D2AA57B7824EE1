-- ================================================================================
-- SCRIPT: Crear base de datos operacional para una compañía
-- PROPÓSITO: Crear la BD y schema para datos operacionales de la compañía
-- AUTOR: EAMR, BITI SOLUTIONS S.A
-- FECHA: 2026-02-19
-- USO: Ejecutar conectado al servidor PostgreSQL (no a una BD específica)
-- ================================================================================

-- ⚠️ CAMBIAR '{schema}' POR EL CÓDIGO DE LA COMPAÑÍA (COMPANY_SCHEMA)
-- Ejemplo: Si la compañía tiene COMPANY_SCHEMA = 'sinai', cambiar todas las ocurrencias

-- 1. Crear la base de datos (ejecutar como superuser conectado a 'postgres')
-- CREATE DATABASE sinai WITH OWNER = cmssystem ENCODING = 'UTF8';

-- 2. Conectarse a la nueva base de datos y ejecutar lo siguiente:
-- \c sinai

-- 3. Crear el schema
CREATE SCHEMA IF NOT EXISTS sinai;

-- 4. Crear la tabla de artículos
CREATE TABLE IF NOT EXISTS sinai.item (
    id_item        INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    code VARCHAR(50) NOT NULL,
    name VARCHAR(200) NOT NULL,
    description VARCHAR(1000),

    -- Label Item fields
    label_item VARCHAR(200),
    label_price DECIMAL(28,8) DEFAULT 0,
    label_item_barcode VARCHAR(200),
    is_label_item BOOLEAN NOT NULL DEFAULT FALSE,

    -- Información básica
    barcode VARCHAR(50),
    category VARCHAR(100),
    subcategory VARCHAR(100),
    brand VARCHAR(100),
    unit_of_measure VARCHAR(20) DEFAULT 'unidad',

    -- Precios
    cost_price DECIMAL(28,8) DEFAULT 0,
    sale_price DECIMAL(28,8) DEFAULT 0,
    tax_rate DECIMAL(28,8) DEFAULT 0,

    -- Stock
    min_stock DECIMAL(28,8) DEFAULT 0,
    max_stock DECIMAL(28,8) DEFAULT 0,
    current_stock DECIMAL(28,8) DEFAULT 0,

    -- Configuración
    image_url VARCHAR(500),
    is_sellable BOOLEAN DEFAULT TRUE,
    is_purchasable BOOLEAN DEFAULT TRUE,
    track_lots BOOLEAN DEFAULT FALSE,
    track_serial_numbers BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,

    -- Auditoría
    createdate     TIMESTAMP         NOT NULL DEFAULT now(),
    record_date    TIMESTAMP         NOT NULL DEFAULT now(),
    created_by     VARCHAR(30)       NOT NULL DEFAULT current_user,
    updated_by     VARCHAR(30)       NOT NULL DEFAULT current_user,
    rowpointer     UUID              NOT NULL DEFAULT gen_random_uuid(),

    CONSTRAINT rpix_sinai_item UNIQUE (rowpointer)
);

-- 5. Crear índices
CREATE UNIQUE INDEX IF NOT EXISTS idx_item_code ON sinai.item(code);
CREATE INDEX IF NOT EXISTS idx_item_barcode ON sinai.item(barcode);
CREATE INDEX IF NOT EXISTS idx_item_category ON sinai.item(category);
CREATE INDEX IF NOT EXISTS idx_item_is_active ON sinai.item(is_active);
CREATE INDEX IF NOT EXISTS idx_item_is_label_item ON sinai.item(is_label_item);

-- 6. Permisos
GRANT SELECT, INSERT, UPDATE, DELETE ON sinai.item TO PUBLIC;

-- 7. Trigger function para actualizar auditoría
CREATE OR REPLACE FUNCTION sinai.tr_item_update_fn()
RETURNS TRIGGER 
LANGUAGE plpgsql
AS $$
BEGIN
    NEW.updated_by := current_user;
    NEW.record_date := now();
    RETURN NEW;
END;
$$;

-- 8. Trigger
DROP TRIGGER IF EXISTS tr_item_update ON sinai.item;
CREATE TRIGGER tr_item_update
BEFORE UPDATE ON sinai.item
FOR EACH ROW
EXECUTE FUNCTION sinai.tr_item_update_fn();

-- 9. Insertar datos de ejemplo
INSERT INTO sinai.item (code, name, description, category, cost_price, sale_price, current_stock, is_label_item)
VALUES 
    ('PROD-001', 'Producto de Ejemplo 1', 'Este es un producto de prueba', 'General', 10.00, 15.00, 100, false),
    ('PROD-002', 'Producto de Ejemplo 2', 'Otro producto de prueba', 'General', 20.00, 30.00, 50, false),
    ('LABEL-001', 'Etiqueta de Precio', 'Artículo tipo etiqueta', 'Etiquetas', 0.50, 1.00, 1000, true)
ON CONFLICT DO NOTHING;

-- Verificar
SELECT * FROM sinai.item;
