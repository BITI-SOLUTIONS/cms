// ================================================================================
// ARCHIVO: CMS.API/Controllers/PermissionController.cs
// PROPÓSITO: Controlador REST para gestión de permisos
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-18
// ================================================================================

using CMS.Data;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CMS.API.Controllers
{
    /// <summary>
    /// Controlador REST para gestión de permisos del sistema.
    /// </summary>
    [Authorize]
    [ApiController]
    [Route("api/[controller]")]
    public class PermissionController : ControllerBase
    {
        private readonly AppDbContext _db;
        private readonly ILogger<PermissionController> _logger;

        public PermissionController(AppDbContext db, ILogger<PermissionController> logger)
        {
            _db = db;
            _logger = logger;
        }

        /// <summary>
        /// Obtiene todos los permisos disponibles
        /// GET: api/permission
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            try
            {
                var permissions = await _db.Permissions
                    .Where(p => p.IS_ACTIVE)
                    .OrderBy(p => p.PERMISSION_KEY)
                    .Select(p => new PermissionDto
                    {
                        Id = p.ID_PERMISSION,
                        PermissionKey = p.PERMISSION_KEY,
                        PermissionName = p.PERMISSION_NAME ?? p.PERMISSION_KEY,
                        Description = p.DESCRIPTION,
                        IsActive = p.IS_ACTIVE
                    })
                    .ToListAsync();

                _logger.LogInformation("📋 Permisos obtenidos: {Count}", permissions.Count);
                return Ok(permissions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo permisos");
                return StatusCode(500, new { message = "Error obteniendo permisos" });
            }
        }

        /// <summary>
        /// Obtiene un permiso por ID
        /// GET: api/permission/{id}
        /// </summary>
        [HttpGet("{id}")]
        public async Task<IActionResult> GetById(int id)
        {
            try
            {
                var permission = await _db.Permissions
                    .Where(p => p.ID_PERMISSION == id)
                    .Select(p => new PermissionDto
                    {
                        Id = p.ID_PERMISSION,
                        PermissionKey = p.PERMISSION_KEY,
                        PermissionName = p.PERMISSION_NAME ?? p.PERMISSION_KEY,
                        Description = p.DESCRIPTION,
                        IsActive = p.IS_ACTIVE
                    })
                    .FirstOrDefaultAsync();

                if (permission == null)
                    return NotFound(new { message = "Permiso no encontrado" });

                return Ok(permission);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo permiso {Id}", id);
                return StatusCode(500, new { message = "Error obteniendo permiso" });
            }
        }

        #region DTOs

        public class PermissionDto
        {
            public int Id { get; set; }
            public string PermissionKey { get; set; } = string.Empty;
            public string PermissionName { get; set; } = string.Empty;
            public string? Description { get; set; }
            public bool IsActive { get; set; }
        }

        #endregion
    }
}
