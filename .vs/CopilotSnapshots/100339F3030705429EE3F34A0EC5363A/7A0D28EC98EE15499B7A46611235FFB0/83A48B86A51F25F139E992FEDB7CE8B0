// ================================================================================
// ARCHIVO: CMS.UI/Filters/SessionValidationFilter.cs
// PROPÓSITO: Filtro para validar que la sesión del usuario es válida
// DESCRIPCIÓN: Verifica que exista compañía seleccionada y JWT en sesión
//              Se aplica a todas las acciones que requieren autenticación
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-14
// ================================================================================

using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;

namespace CMS.UI.Filters
{
    /// <summary>
    /// Filtro que valida que la sesión del usuario tenga los datos requeridos:
    /// - Compañía seleccionada
    /// - JWT de API
    /// </summary>
    public class SessionValidationFilter : IActionFilter
    {
        private readonly ILogger<SessionValidationFilter> _logger;

        public SessionValidationFilter(ILogger<SessionValidationFilter> logger)
        {
            _logger = logger;
        }

        public void OnActionExecuting(ActionExecutingContext context)
        {
            // Verificar si la acción tiene [SkipSessionValidation]
            var skipValidation = context.ActionDescriptor.EndpointMetadata
                .OfType<SkipSessionValidationAttribute>()
                .Any();

            if (skipValidation)
            {
                return;
            }

            var httpContext = context.HttpContext;
            var user = httpContext.User;

            // Si el usuario no está autenticado, dejar que [Authorize] maneje
            if (user.Identity?.IsAuthenticated != true)
            {
                return;
            }

            // Verificar que hay compañía en sesión
            var companyId = httpContext.Session.GetInt32("SelectedCompanyId");
            var companySchema = httpContext.Session.GetString("SelectedCompanySchema");
            var apiToken = httpContext.Session.GetString("ApiToken");

            // Si falta alguno, redirigir a SelectCompany
            if (companyId == null || string.IsNullOrEmpty(companySchema) || string.IsNullOrEmpty(apiToken))
            {
                _logger.LogWarning(
                    "⚠️ Sesión inválida: CompanyId={CompanyId}, Schema={Schema}, HasToken={HasToken}. Usuario: {User}",
                    companyId?.ToString() ?? "null",
                    companySchema ?? "null",
                    !string.IsNullOrEmpty(apiToken),
                    user.Identity?.Name ?? "desconocido");

                // Limpiar sesión
                httpContext.Session.Clear();

                // Redirigir a SelectCompany con forceLogout
                context.Result = new RedirectToActionResult(
                    "SelectCompany", 
                    "Account", 
                    new { forceLogout = true });
            }
        }

        public void OnActionExecuted(ActionExecutedContext context)
        {
            // No se necesita hacer nada después de la acción
        }
    }

    /// <summary>
    /// Atributo para marcar controladores/acciones que requieren sesión válida
    /// </summary>
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = false)]
    public class RequireValidSessionAttribute : TypeFilterAttribute
    {
        public RequireValidSessionAttribute() : base(typeof(SessionValidationFilter))
        {
        }
    }

    /// <summary>
    /// Atributo para excluir una acción o controlador de la validación de sesión
    /// </summary>
    [AttributeUsage(AttributeTargets.Class | AttributeTargets.Method, AllowMultiple = false)]
    public class SkipSessionValidationAttribute : Attribute
    {
    }
}
