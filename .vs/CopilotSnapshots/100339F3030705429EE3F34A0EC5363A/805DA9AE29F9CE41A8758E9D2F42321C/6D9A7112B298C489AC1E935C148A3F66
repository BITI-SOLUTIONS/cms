-- ================================================================================
-- SCRIPT: add_system_permissions.sql
-- PROPÓSITO: Agregar permisos de sistema adicionales
-- AUTOR: EAMR, BITI SOLUTIONS S.A
-- FECHA: 2026-02-19
-- ================================================================================

-- ================================================================================
-- PERMISOS DE SISTEMA A CREAR
-- ================================================================================
-- System.ViewAllCompanies     - Ver todas las compañías (ya existe)
-- System.ManageCompanies      - Crear/editar/eliminar compañías
-- System.SetAdminCompany      - Cambiar cuál compañía es la Admin
-- System.ViewSystemConfig     - Ver configuración del sistema
-- System.EditSystemConfig     - Editar configuración del sistema
-- System.ViewAllUsers         - Ver todos los usuarios del sistema
-- System.ManageAllUsers       - Gestionar todos los usuarios (crear/editar/eliminar)
-- System.ViewGlobalAudit      - Ver logs de auditoría global
-- System.ManageRoles          - Gestionar roles del sistema
-- System.ManagePermissions    - Gestionar permisos del sistema

-- ================================================================================
-- CREAR PERMISOS
-- ================================================================================

-- System.ManageCompanies
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ManageCompanies', 'Gestionar Compañías', 'Permite crear, editar y eliminar compañías del sistema.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ManageCompanies');

-- System.SetAdminCompany
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.SetAdminCompany', 'Configurar Compañía Admin', 'Permite cambiar cuál compañía es la administradora del sistema.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.SetAdminCompany');

-- System.ViewSystemConfig
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ViewSystemConfig', 'Ver Configuración del Sistema', 'Permite ver la configuración global del sistema (SMTP, etc).', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ViewSystemConfig');

-- System.EditSystemConfig
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.EditSystemConfig', 'Editar Configuración del Sistema', 'Permite editar la configuración global del sistema.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.EditSystemConfig');

-- System.ViewAllUsers
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ViewAllUsers', 'Ver Todos los Usuarios', 'Permite ver todos los usuarios del sistema, sin importar la compañía.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ViewAllUsers');

-- System.ManageAllUsers
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ManageAllUsers', 'Gestionar Todos los Usuarios', 'Permite crear, editar y eliminar cualquier usuario del sistema.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ManageAllUsers');

-- System.ViewGlobalAudit
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ViewGlobalAudit', 'Ver Auditoría Global', 'Permite ver los logs de auditoría de todas las compañías.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ViewGlobalAudit');

-- System.ManageRoles
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ManageRoles', 'Gestionar Roles del Sistema', 'Permite crear, editar y eliminar roles globales del sistema.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ManageRoles');

-- System.ManagePermissions
INSERT INTO admin.permission (permission_key, permission_name, description, module, is_active, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 'System.ManagePermissions', 'Gestionar Permisos del Sistema', 'Permite crear, editar y eliminar permisos del sistema.', 'System', TRUE, gen_random_uuid(), NOW(), NOW(), 'SYSTEM', 'SYSTEM'
WHERE NOT EXISTS (SELECT 1 FROM admin.permission WHERE permission_key = 'System.ManagePermissions');

-- ================================================================================
-- ASIGNAR TODOS LOS PERMISOS SYSTEM.* AL ROL ADMIN
-- ================================================================================
INSERT INTO admin.role_permission (id_role, id_permission, is_allowed, rowpointer, record_date, createdate, created_by, updated_by)
SELECT 
    r.id_role,
    p.id_permission,
    TRUE,
    gen_random_uuid(),
    NOW(),
    NOW(),
    'SYSTEM',
    'SYSTEM'
FROM admin.role r
CROSS JOIN admin.permission p
WHERE r.role_name = 'Admin'
AND p.permission_key LIKE 'System.%'
AND p.is_active = TRUE
AND NOT EXISTS (
    SELECT 1 FROM admin.role_permission rp 
    WHERE rp.id_role = r.id_role 
    AND rp.id_permission = p.id_permission
);

-- ================================================================================
-- VERIFICACIÓN
-- ================================================================================
SELECT '=== PERMISOS DE SISTEMA ===' AS info;
SELECT id_permission, permission_key, permission_name 
FROM admin.permission 
WHERE module = 'System' 
ORDER BY permission_key;

SELECT '=== PERMISOS ASIGNADOS A ADMIN ===' AS info;
SELECT r.role_name, p.permission_key
FROM admin.role_permission rp
JOIN admin.role r ON r.id_role = rp.id_role
JOIN admin.permission p ON p.id_permission = rp.id_permission
WHERE p.module = 'System'
ORDER BY p.permission_key;
