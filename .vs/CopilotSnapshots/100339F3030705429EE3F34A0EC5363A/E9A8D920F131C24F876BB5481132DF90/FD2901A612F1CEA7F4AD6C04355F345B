// ================================================================================
// ARCHIVO: CMS.UI/Middleware/SessionValidationMiddleware.cs
// PROPÓSITO: Middleware para validar la sesión en cada request
// DESCRIPCIÓN: Verifica que si el usuario está autenticado, tenga una sesión válida
//              Si no, lo redirige a SelectCompany con un mensaje
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-14
// ================================================================================

using System.Web;

namespace CMS.UI.Middleware
{
    /// <summary>
    /// Middleware que valida que usuarios autenticados tengan una sesión válida
    /// </summary>
    public class SessionValidationMiddleware
    {
        private readonly RequestDelegate _next;
        private readonly ILogger<SessionValidationMiddleware> _logger;

        // Rutas que no requieren validación de sesión
        private static readonly string[] _excludedPaths = new[]
        {
            "/Account/SelectCompany",
            "/Account/Login",
            "/Account/SignOut",
            "/Account/SignOutPost",
            "/Account/SignedOut",
            "/Account/ForgotPassword",
            "/Account/ResetPassword",
            "/Account/AccessDenied",
            "/Home/Error",
            "/_framework",
            "/_vs",
            "/css",
            "/js",
            "/img",
            "/lib",
            "/favicon"
        };

        public SessionValidationMiddleware(RequestDelegate next, ILogger<SessionValidationMiddleware> logger)
        {
            _next = next;
            _logger = logger;
        }

        public async Task InvokeAsync(HttpContext context)
        {
            var path = context.Request.Path.Value ?? "";

            // Verificar si la ruta está excluida
            var isExcluded = _excludedPaths.Any(p => path.StartsWith(p, StringComparison.OrdinalIgnoreCase));

            if (!isExcluded)
            {
                // Verificar sesión para cualquier ruta protegida
                var companyId = context.Session.GetInt32("SelectedCompanyId");
                var companySchema = context.Session.GetString("SelectedCompanySchema");
                var apiToken = context.Session.GetString("ApiToken");

                // Si no hay sesión válida (sin importar si está autenticado o no)
                if (companyId == null || string.IsNullOrEmpty(companySchema) || string.IsNullOrEmpty(apiToken))
                {
                    _logger.LogWarning(
                        "🔒 Sesión inválida detectada. Path: {Path}, User: {User}. Redirigiendo a SelectCompany.",
                        path,
                        context.User.Identity?.Name ?? "anónimo");

                    // Limpiar sesión
                    context.Session.Clear();

                    // Mensaje amigable para el usuario
                    var message = HttpUtility.UrlEncode("Debe seleccionar una compañía válida para continuar.");

                    // Redirigir a SelectCompany con mensaje
                    context.Response.Redirect($"/Account/SelectCompany?forceLogout=true&message={message}");
                    return;
                }
            }

            await _next(context);
        }
    }

    /// <summary>
    /// Extensión para registrar el middleware
    /// </summary>
    public static class SessionValidationMiddlewareExtensions
    {
        public static IApplicationBuilder UseSessionValidation(this IApplicationBuilder builder)
        {
            return builder.UseMiddleware<SessionValidationMiddleware>();
        }
    }
}
