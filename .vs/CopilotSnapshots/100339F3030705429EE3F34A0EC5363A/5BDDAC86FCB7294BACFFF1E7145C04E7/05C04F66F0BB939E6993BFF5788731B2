// ================================================================================
// ARCHIVO: CMS.Data/Services/CompanyConfigService.cs
// PROPÓSITO: Servicio para cargar configuración de compañía desde BD
// ================================================================================

using CMS.Data;
using CMS.Entities;
using Microsoft.EntityFrameworkCore;
using System;

namespace CMS.Data.Services
{
    /// <summary>
    /// Servicio para obtener la configuración de una compañía desde [ADMIN].[COMPANY]
    /// Se utiliza en el bootstrap de Program.cs
    /// </summary>
    public class CompanyConfigService
    {
        private readonly AppDbContext _context;

        // Permiso requerido para ver todas las compañías
        public const string VIEW_ALL_COMPANIES_PERMISSION = "System.ViewAllCompanies";

        public CompanyConfigService(AppDbContext context)
        {
            _context = context ?? throw new ArgumentNullException(nameof(context));
        }

        /// <summary>
        /// Obtiene la configuración de una compañía por su COMPANY_SCHEMA
        /// </summary>
        public async Task<Company> GetCompanyConfigAsync(string companySchema)
        {
            if (string.IsNullOrWhiteSpace(companySchema))
                throw new ArgumentException("companySchema no puede estar vacío", nameof(companySchema));

            try
            {
                var company = await _context.Companies
                    .AsNoTracking()
                    .Where(c => c.COMPANY_SCHEMA == companySchema && c.IS_ACTIVE)
                    .FirstOrDefaultAsync();

                if (company == null)
                    throw new InvalidOperationException(
                        $"No se encontró compañía activa con COMPANY_SCHEMA = '{companySchema}'. " +
                        $"Verifica que: 1) La tabla [ADMIN].[COMPANY] existe, " +
                        $"2) Existe un registro con COMPANY_SCHEMA = '{companySchema}', " +
                        $"3) IS_ACTIVE = 1 (true)");

                return company;
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    $"Error al obtener configuración de compañía '{companySchema}' desde [ADMIN].[COMPANY]",
                    ex);
            }
        }

        /// <summary>
        /// Obtiene todas las compañías activas (solo para administradores del sistema)
        /// </summary>
        public async Task<List<Company>> GetAllActiveCompaniesAsync()
        {
            try
            {
                return await _context.Companies
                    .AsNoTracking()
                    .Where(c => c.IS_ACTIVE)
                    .OrderBy(c => c.COMPANY_NAME)
                    .ToListAsync();
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    "Error al obtener todas las compañías activas",
                    ex);
            }
        }

        /// <summary>
        /// Obtiene las compañías que un usuario tiene asignadas
        /// </summary>
        public async Task<List<Company>> GetUserCompaniesAsync(int userId)
        {
            try
            {
                return await (
                    from uc in _context.UserCompanies
                    join c in _context.Companies on uc.ID_COMPANY equals c.ID
                    where uc.ID_USER == userId && uc.IS_ACTIVE && c.IS_ACTIVE
                    orderby c.COMPANY_NAME
                    select c
                ).AsNoTracking().ToListAsync();
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    $"Error al obtener compañías del usuario {userId}",
                    ex);
            }
        }

        /// <summary>
        /// Obtiene las compañías visibles para un usuario.
        /// - Si el usuario tiene el permiso System.ViewAllCompanies en una compañía Admin → ve TODAS las compañías
        /// - Si no → solo ve las compañías que tiene asignadas
        /// </summary>
        public async Task<List<Company>> GetVisibleCompaniesForUserAsync(int userId)
        {
            try
            {
                // 1. Verificar si el usuario tiene acceso a todas las compañías
                var hasGlobalAccess = await HasViewAllCompaniesPermissionAsync(userId);

                if (hasGlobalAccess)
                {
                    // Usuario es super admin, puede ver todas las compañías
                    return await GetAllActiveCompaniesAsync();
                }

                // 2. Usuario normal, solo ve sus compañías asignadas
                return await GetUserCompaniesAsync(userId);
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    $"Error al obtener compañías visibles para usuario {userId}",
                    ex);
            }
        }

        /// <summary>
        /// Verifica si un usuario tiene el permiso de ver todas las compañías.
        /// Requiere: estar en una compañía Admin + tener el permiso System.ViewAllCompanies
        /// </summary>
        public async Task<bool> HasViewAllCompaniesPermissionAsync(int userId)
        {
            try
            {
                // Buscar si el usuario tiene el permiso System.ViewAllCompanies
                // en una compañía que sea IS_ADMIN_COMPANY = true
                var hasPermission = await (
                    from uc in _context.UserCompanies
                    join c in _context.Companies on uc.ID_COMPANY equals c.ID
                    join ucr in _context.UserCompanyRoles on new { uc.ID_USER, uc.ID_COMPANY } equals new { ucr.ID_USER, ucr.ID_COMPANY }
                    join rp in _context.RolePermissions on ucr.ID_ROLE equals rp.RoleId
                    join p in _context.Permissions on rp.PermissionId equals p.ID_PERMISSION
                    where uc.ID_USER == userId
                          && uc.IS_ACTIVE
                          && c.IS_ACTIVE
                          && c.IS_ADMIN_COMPANY  // Solo en compañía Admin
                          && ucr.IS_ACTIVE
                          && p.IS_ACTIVE
                          && p.PERMISSION_KEY == VIEW_ALL_COMPANIES_PERMISSION
                    select uc.ID_USER
                ).AnyAsync();

                // También verificar permisos directos otorgados (no denegados)
                if (!hasPermission)
                {
                    hasPermission = await (
                        from uc in _context.UserCompanies
                        join c in _context.Companies on uc.ID_COMPANY equals c.ID
                        join ucp in _context.UserCompanyPermissions on new { uc.ID_USER, uc.ID_COMPANY } equals new { ucp.ID_USER, ucp.ID_COMPANY }
                        join p in _context.Permissions on ucp.ID_PERMISSION equals p.ID_PERMISSION
                        where uc.ID_USER == userId
                              && uc.IS_ACTIVE
                              && c.IS_ACTIVE
                              && c.IS_ADMIN_COMPANY  // Solo en compañía Admin
                              && ucp.IS_ALLOWED      // Permiso otorgado, no denegado
                              && p.IS_ACTIVE
                              && p.PERMISSION_KEY == VIEW_ALL_COMPANIES_PERMISSION
                        select uc.ID_USER
                    ).AnyAsync();
                }

                return hasPermission;
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    $"Error verificando permiso de acceso global para usuario {userId}",
                    ex);
            }
        }

        /// <summary>
        /// Verifica si un usuario puede ver/gestionar una compañía específica
        /// </summary>
        public async Task<bool> CanUserAccessCompanyAsync(int userId, int companyId)
        {
            try
            {
                // Si tiene permiso global, puede acceder a cualquier compañía
                if (await HasViewAllCompaniesPermissionAsync(userId))
                {
                    return true;
                }

                // Verificar si tiene la compañía asignada
                return await _context.UserCompanies
                    .AnyAsync(uc => uc.ID_USER == userId 
                                    && uc.ID_COMPANY == companyId 
                                    && uc.IS_ACTIVE);
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    $"Error verificando acceso del usuario {userId} a compañía {companyId}",
                    ex);
            }
        }

        /// <summary>
        /// Obtiene la compañía Admin del sistema (si existe)
        /// </summary>
        public async Task<Company?> GetAdminCompanyAsync()
        {
            try
            {
                return await _context.Companies
                    .AsNoTracking()
                    .Where(c => c.IS_ADMIN_COMPANY && c.IS_ACTIVE)
                    .FirstOrDefaultAsync();
            }
            catch (Exception ex)
            {
                throw new InvalidOperationException(
                    "Error al obtener la compañía Admin",
                    ex);
            }
        }
    }
}