// ================================================================================
// ARCHIVO: CMS.UI/Controllers/AdminController.cs
// PROPÓSITO: Controlador para el Dashboard de Administración
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-16
// ================================================================================

using CMS.UI.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace CMS.UI.Controllers
{
    [Authorize]
    public class AdminController : Controller
    {
        private readonly UsersApiService _usersApi;
        private readonly PermissionsApiService _permissionsApi;
        private readonly MenusAdminApiService _menusApi;
        private readonly ILogger<AdminController> _logger;

        public AdminController(
            UsersApiService usersApi,
            PermissionsApiService permissionsApi,
            MenusAdminApiService menusApi,
            ILogger<AdminController> logger)
        {
            _usersApi = usersApi;
            _permissionsApi = permissionsApi;
            _menusApi = menusApi;
            _logger = logger;
        }

        /// <summary>
        /// Dashboard de administración con resumen del sistema
        /// GET: /Admin/Dashboard
        /// </summary>
        public async Task<IActionResult> Dashboard()
        {
            try
            {
                // Obtener estadísticas
                var users = await _usersApi.GetUsersAsync();
                var permissions = await _permissionsApi.GetAllAsync();
                var menus = await _menusApi.GetAllAsync();

                // Obtener información de sesión
                var companyId = HttpContext.Session.GetString("CompanyId");
                var companyName = HttpContext.Session.GetString("CompanyName");
                var userName = User.Identity?.Name ?? "Usuario";

                var model = new AdminDashboardViewModel
                {
                    // Estadísticas
                    TotalUsers = users.Data?.Count ?? 0,
                    ActiveUsers = users.Data?.Count(u => u.IsActive) ?? 0,
                    InactiveUsers = users.Data?.Count(u => !u.IsActive) ?? 0,
                    UnverifiedUsers = users.Data?.Count(u => !u.IsEmailVerified) ?? 0,
                    
                    TotalPermissions = permissions.Count,
                    TotalMenus = menus.Count,
                    ActiveMenus = menus.Count(m => m.IsActive),
                    
                    // Permisos por módulo
                    PermissionsByModule = permissions
                        .GroupBy(p => p.Module)
                        .Select(g => new ModuleStats { Module = g.Key, Count = g.Count() })
                        .OrderByDescending(m => m.Count)
                        .ToList(),
                    
                    // Últimos usuarios
                    RecentUsers = users.Data?
                        .OrderByDescending(u => u.CreateDate)
                        .Take(5)
                        .ToList() ?? new(),
                    
                    // Contexto actual
                    CurrentCompanyId = companyId ?? "N/A",
                    CurrentCompanyName = companyName ?? "Sin compañía",
                    CurrentUserName = userName
                };

                return View(model);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cargando dashboard de administración");
                TempData["Error"] = "Error al cargar el dashboard";
                return View(new AdminDashboardViewModel());
            }
        }

        #region ViewModels

        public class AdminDashboardViewModel
        {
            // Usuarios
            public int TotalUsers { get; set; }
            public int ActiveUsers { get; set; }
            public int InactiveUsers { get; set; }
            public int UnverifiedUsers { get; set; }
            
            // Permisos y Menús
            public int TotalPermissions { get; set; }
            public int TotalMenus { get; set; }
            public int ActiveMenus { get; set; }
            
            // Desglose
            public List<ModuleStats> PermissionsByModule { get; set; } = new();
            public List<Models.Users.UserListViewModel> RecentUsers { get; set; } = new();
            
            // Contexto
            public string CurrentCompanyId { get; set; } = string.Empty;
            public string CurrentCompanyName { get; set; } = string.Empty;
            public string CurrentUserName { get; set; } = string.Empty;
        }

        public class ModuleStats
        {
            public string Module { get; set; } = string.Empty;
            public int Count { get; set; }
        }

        #endregion
    }
}
