// ================================================================================
// ARCHIVO: CMS.UI/Controllers/AdminController.cs
// PROPÓSITO: Controlador para funcionalidades administrativas del sistema
// DESCRIPCIÓN: Maneja Audit Trail, System Logs, API Keys, Jobs, Backup, Health Check
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-14
// ================================================================================

using CMS.UI.Models.Admin;
using CMS.UI.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace CMS.UI.Controllers
{
    [Authorize]
    public class AdminController : Controller
    {
        private readonly ILogger<AdminController> _logger;
        private readonly AdminApiService _adminApiService;

        public AdminController(
            ILogger<AdminController> logger,
            AdminApiService adminApiService)
        {
            _logger = logger;
            _adminApiService = adminApiService;
        }

        #region Audit Trail

        /// <summary>
        /// Vista principal de Audit Trail
        /// GET: /Admin/Audit
        /// </summary>
        public async Task<IActionResult> Audit(string? search = null, string? action = null, 
            DateTime? from = null, DateTime? to = null, int page = 1)
        {
            var model = await _adminApiService.GetAuditTrailAsync(search, action, from, to, page, 50);
            return View(model);
        }

        #endregion

        #region System Logs

        /// <summary>
        /// Vista de System Logs
        /// GET: /Admin/Logs
        /// </summary>
        public async Task<IActionResult> Logs(string? level = null, string? source = null, 
            DateTime? from = null, DateTime? to = null, int page = 1)
        {
            var model = await _adminApiService.GetSystemLogsAsync(level, source, from, to, page, 100);
            return View(model);
        }

        #endregion

        #region API Keys

        /// <summary>
        /// Vista de gestión de API Keys
        /// GET: /Admin/APIKeys
        /// </summary>
        public async Task<IActionResult> APIKeys()
        {
            var model = await _adminApiService.GetApiKeysAsync();
            return View(model);
        }

        /// <summary>
        /// Crear nueva API Key
        /// POST: /Admin/APIKeys/Create
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateApiKey(CreateApiKeyViewModel model)
        {
            if (!ModelState.IsValid)
            {
                TempData["Error"] = "Datos inválidos";
                return RedirectToAction(nameof(APIKeys));
            }

            var (success, apiKey, error) = await _adminApiService.CreateApiKeyAsync(model);

            if (success)
            {
                TempData["Success"] = $"API Key '{model.Name}' creada exitosamente";
                TempData["NewApiKey"] = apiKey;
            }
            else
            {
                TempData["Error"] = error ?? "Error creando API Key";
            }

            return RedirectToAction(nameof(APIKeys));
        }

        /// <summary>
        /// Revocar API Key
        /// POST: /Admin/APIKeys/Revoke/{id}
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> RevokeApiKey(int id)
        {
            var success = await _adminApiService.RevokeApiKeyAsync(id);

            if (success)
                TempData["Success"] = "API Key revocada exitosamente";
            else
                TempData["Error"] = "Error revocando API Key";

            return RedirectToAction(nameof(APIKeys));
        }

        #endregion

        #region Job Scheduler

        /// <summary>
        /// Vista de Job Scheduler
        /// GET: /Admin/Jobs
        /// </summary>
        public async Task<IActionResult> Jobs()
        {
            var model = await _adminApiService.GetJobsAsync();
            return View(model);
        }

        /// <summary>
        /// Ejecutar job manualmente
        /// POST: /Admin/Jobs/Run/{id}
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> RunJob(int id)
        {
            var success = await _adminApiService.RunJobAsync(id);

            if (success)
                TempData["Success"] = "Job iniciado. Puede tardar unos minutos en completarse.";
            else
                TempData["Error"] = "Error ejecutando job";

            return RedirectToAction(nameof(Jobs));
        }

        /// <summary>
        /// Pausar/Reanudar job
        /// POST: /Admin/Jobs/Toggle/{id}
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> ToggleJob(int id)
        {
            var success = await _adminApiService.ToggleJobAsync(id);

            if (success)
                TempData["Success"] = "Estado del job actualizado";
            else
                TempData["Error"] = "Error actualizando estado del job";

            return RedirectToAction(nameof(Jobs));
        }

        #endregion

        #region Backup & Restore

        /// <summary>
        /// Vista de Backup & Restore
        /// GET: /Admin/Backup
        /// </summary>
        public async Task<IActionResult> Backup()
        {
            var model = await _adminApiService.GetBackupsAsync();
            return View(model);
        }

        /// <summary>
        /// Crear backup manual
        /// POST: /Admin/Backup/Create
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> CreateBackup(string type = "full")
        {
            var success = await _adminApiService.CreateBackupAsync(type);

            if (success)
                TempData["Success"] = "Backup iniciado. Recibirá una notificación cuando se complete.";
            else
                TempData["Error"] = "Error iniciando backup";

            return RedirectToAction(nameof(Backup));
        }

        /// <summary>
        /// Restaurar backup
        /// POST: /Admin/Backup/Restore/{id}
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> RestoreBackup(int id)
        {
            var success = await _adminApiService.RestoreBackupAsync(id);

            if (success)
                TempData["Warning"] = "Restauración iniciada. El sistema puede estar temporalmente no disponible.";
            else
                TempData["Error"] = "Error iniciando restauración";

            return RedirectToAction(nameof(Backup));
        }

        /// <summary>
        /// Descargar backup
        /// GET: /Admin/Backup/Download/{id}
        /// </summary>
        public async Task<IActionResult> DownloadBackup(int id)
        {
            // TODO: Implementar descarga real
            TempData["Info"] = "La descarga comenzará en breve...";
            return RedirectToAction(nameof(Backup));
        }

        #endregion

        #region Health Check

        /// <summary>
        /// Vista de Health Check
        /// GET: /Admin/Health
        /// </summary>
        public async Task<IActionResult> Health()
        {
            var model = await _adminApiService.GetHealthCheckAsync();
            return View(model);
        }

        /// <summary>
        /// Ejecutar health check manual
        /// POST: /Admin/Health/Check
        /// </summary>
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> RunHealthCheck()
        {
            TempData["Success"] = "Health check completado";
            return RedirectToAction(nameof(Health));
        }

        #endregion

        #region Dashboard

        /// <summary>
        /// Dashboard de administración con resumen del sistema
        /// GET: /Admin/Dashboard
        /// </summary>
        public async Task<IActionResult> Dashboard()
        {
            try
            {
                // Obtener información de sesión
                var companyId = HttpContext.Session.GetString("CompanyId");
                var companyName = HttpContext.Session.GetString("CompanyName");
                var userName = User.Identity?.Name ?? "Usuario";

                var model = new AdminDashboardViewModel
                {
                    CurrentCompanyId = companyId ?? "N/A",
                    CurrentCompanyName = companyName ?? "Sin compañía",
                    CurrentUserName = userName
                };

                // Intentar obtener estadísticas de usuarios
                try
                {
                    // Usar el servicio admin existente si tiene los datos
                    // Por ahora, dejamos los valores en 0 y se pueden llenar después
                }
                catch (Exception ex)
                {
                    _logger.LogWarning(ex, "No se pudieron cargar estadísticas");
                }

                return View(model);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error cargando dashboard de administración");
                TempData["Error"] = "Error al cargar el dashboard";
                return View(new AdminDashboardViewModel());
            }
        }

        #endregion
    }

    #region ViewModels

    public class AdminDashboardViewModel
    {
        // Usuarios
        public int TotalUsers { get; set; }
        public int ActiveUsers { get; set; }
        public int InactiveUsers { get; set; }
        public int UnverifiedUsers { get; set; }

        // Permisos y Menús
        public int TotalPermissions { get; set; }
        public int TotalMenus { get; set; }
        public int ActiveMenus { get; set; }

        // Desglose
        public List<ModuleStats> PermissionsByModule { get; set; } = new();
        public List<CMS.UI.Models.Users.UserListViewModel> RecentUsers { get; set; } = new();

        // Contexto
        public string CurrentCompanyId { get; set; } = string.Empty;
        public string CurrentCompanyName { get; set; } = string.Empty;
        public string CurrentUserName { get; set; } = string.Empty;
    }

    public class ModuleStats
    {
        public string Module { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    #endregion
}
