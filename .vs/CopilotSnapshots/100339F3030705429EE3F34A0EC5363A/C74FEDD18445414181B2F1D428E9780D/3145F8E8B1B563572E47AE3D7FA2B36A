// ================================================================================
// ARCHIVO: CMS.UI/Services/UserAuthApiService.cs
// PROPÓSITO: Servicio para consumir la API de autorización por compañía
// DESCRIPCIÓN: Gestión de roles y permisos de usuarios en compañías específicas
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-16
// ================================================================================

using System.Net.Http.Headers;
using System.Text.Json;

namespace CMS.UI.Services
{
    /// <summary>
    /// Servicio para gestionar la autorización de usuarios por compañía
    /// </summary>
    public class UserAuthApiService
    {
        private readonly HttpClient _httpClient;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly ILogger<UserAuthApiService> _logger;
        private readonly IConfiguration _configuration;

        public UserAuthApiService(
            HttpClient httpClient,
            IHttpContextAccessor httpContextAccessor,
            ILogger<UserAuthApiService> logger,
            IConfiguration configuration)
        {
            _httpClient = httpClient;
            _httpContextAccessor = httpContextAccessor;
            _logger = logger;
            _configuration = configuration;
        }

        #region DTOs

        public class UserCompanyRoleDto
        {
            public int RoleId { get; set; }
            public string RoleName { get; set; } = string.Empty;
            public bool IsActive { get; set; }
            public bool IsAssigned { get; set; }
        }

        public class UserCompanyPermissionDto
        {
            public int PermissionId { get; set; }
            public string PermissionKey { get; set; } = string.Empty;
            public string PermissionName { get; set; } = string.Empty;
            public string Module { get; set; } = string.Empty;
            public string Source { get; set; } = string.Empty;
            public bool IsAllowed { get; set; }
            public bool IsDenied { get; set; }
        }

        public class UserCompanyAuthSummary
        {
            public int UserId { get; set; }
            public string UserName { get; set; } = string.Empty;
            public int CompanyId { get; set; }
            public string CompanyName { get; set; } = string.Empty;
            public List<UserCompanyRoleDto> Roles { get; set; } = new();
            public List<UserCompanyPermissionDto> Permissions { get; set; } = new();
            public int TotalEffectivePermissions { get; set; }
        }

        public class EffectivePermissionsResult
        {
            public int UserId { get; set; }
            public int CompanyId { get; set; }
            public List<string> Roles { get; set; } = new();
            public List<string> EffectivePermissions { get; set; } = new();
            public List<string> DeniedPermissions { get; set; } = new();
            public int TotalPermissions { get; set; }
        }

        #endregion

        private void ConfigureAuthHeader()
        {
            var token = _httpContextAccessor.HttpContext?.Session.GetString("JwtToken");
            if (!string.IsNullOrEmpty(token))
            {
                _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }
        }

        private string GetApiBaseUrl()
        {
            var environment = _configuration["Environment"] ?? "Development";
            return _configuration[$"ApiSettings:{environment}:BaseUrl"] ?? "https://localhost:7001";
        }

        /// <summary>
        /// Obtiene el resumen completo de autorización de un usuario en una compañía
        /// </summary>
        public async Task<UserCompanyAuthSummary?> GetAuthSummaryAsync(int userId, int companyId)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/auth";
                
                var response = await _httpClient.GetAsync(url);
                
                if (response.IsSuccessStatusCode)
                {
                    var json = await response.Content.ReadAsStringAsync();
                    return JsonSerializer.Deserialize<UserCompanyAuthSummary>(json, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                }

                _logger.LogWarning("Error obteniendo resumen de autorización: {Status}", response.StatusCode);
                return null;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo resumen de autorización");
                return null;
            }
        }

        /// <summary>
        /// Obtiene los roles asignados a un usuario en una compañía
        /// </summary>
        public async Task<List<UserCompanyRoleDto>> GetRolesAsync(int userId, int companyId)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/roles";
                
                var response = await _httpClient.GetAsync(url);
                
                if (response.IsSuccessStatusCode)
                {
                    var json = await response.Content.ReadAsStringAsync();
                    return JsonSerializer.Deserialize<List<UserCompanyRoleDto>>(json, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    }) ?? new();
                }

                return new();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo roles");
                return new();
            }
        }

        /// <summary>
        /// Asigna un rol a un usuario en una compañía
        /// </summary>
        public async Task<bool> AssignRoleAsync(int userId, int companyId, int roleId)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/roles";
                
                var content = new StringContent(
                    JsonSerializer.Serialize(new { roleId }),
                    System.Text.Encoding.UTF8,
                    "application/json");

                var response = await _httpClient.PostAsync(url, content);
                return response.IsSuccessStatusCode;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error asignando rol");
                return false;
            }
        }

        /// <summary>
        /// Remueve un rol de un usuario en una compañía
        /// </summary>
        public async Task<bool> RemoveRoleAsync(int userId, int companyId, int roleId)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/roles/{roleId}";
                
                var response = await _httpClient.DeleteAsync(url);
                return response.IsSuccessStatusCode;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error removiendo rol");
                return false;
            }
        }

        /// <summary>
        /// Otorga un permiso directo a un usuario en una compañía
        /// </summary>
        public async Task<bool> GrantPermissionAsync(int userId, int companyId, int permissionId)
        {
            return await SetPermissionAsync(userId, companyId, permissionId, true);
        }

        /// <summary>
        /// Deniega un permiso a un usuario en una compañía
        /// </summary>
        public async Task<bool> DenyPermissionAsync(int userId, int companyId, int permissionId)
        {
            return await SetPermissionAsync(userId, companyId, permissionId, false);
        }

        private async Task<bool> SetPermissionAsync(int userId, int companyId, int permissionId, bool isAllowed)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/permissions";
                
                var content = new StringContent(
                    JsonSerializer.Serialize(new { permissionId, isAllowed }),
                    System.Text.Encoding.UTF8,
                    "application/json");

                var response = await _httpClient.PostAsync(url, content);
                return response.IsSuccessStatusCode;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error configurando permiso");
                return false;
            }
        }

        /// <summary>
        /// Remueve un permiso directo de un usuario
        /// </summary>
        public async Task<bool> RemoveDirectPermissionAsync(int userId, int companyId, int permissionId)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/permissions/{permissionId}";
                
                var response = await _httpClient.DeleteAsync(url);
                return response.IsSuccessStatusCode;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error removiendo permiso directo");
                return false;
            }
        }

        /// <summary>
        /// Obtiene los permisos efectivos calculados
        /// </summary>
        public async Task<EffectivePermissionsResult?> GetEffectivePermissionsAsync(int userId, int companyId)
        {
            try
            {
                ConfigureAuthHeader();
                var url = $"{GetApiBaseUrl()}/api/users/{userId}/companies/{companyId}/effective-permissions";
                
                var response = await _httpClient.GetAsync(url);
                
                if (response.IsSuccessStatusCode)
                {
                    var json = await response.Content.ReadAsStringAsync();
                    return JsonSerializer.Deserialize<EffectivePermissionsResult>(json, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                }

                return null;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo permisos efectivos");
                return null;
            }
        }
    }
}
