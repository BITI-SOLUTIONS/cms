using CMS.Data;
using CMS.Data.Services;
using CMS.Entities;
using CMS.Application.DTOs;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CMS.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly AppDbContext _db;
        private readonly JwtTokenService _jwtService;
        private readonly PermissionService _permissionService;
        private readonly ILogger<AuthController> _logger;

        public AuthController(
            AppDbContext db,
            JwtTokenService jwtService,
            PermissionService permissionService,
            ILogger<AuthController> logger)
        {
            _db = db;
            _jwtService = jwtService;
            _permissionService = permissionService;
            _logger = logger;
        }

        // =====================================================================
        // CLASES AUXILIARES (mantener compatibilidad)
        // =====================================================================
        public class AzureUserInfo
        {
            public string? ObjectId { get; set; }
            public string? UserPrincipalName { get; set; }
            public string? DisplayName { get; set; }
            public string? Email { get; set; }
        }

        public class CmsUserDto
        {
            public int Id { get; set; }
            public string Username { get; set; } = default!;
            public string? DisplayName { get; set; }
            public string? Email { get; set; }
            public List<string> Roles { get; set; } = new();
        }

        // =====================================================================
        // ENDPOINT EXISTENTE: sync-user (mantener funcionalidad)
        // =====================================================================
        [AllowAnonymous]
        [HttpPost("sync-user")]
        public async Task<ActionResult<CmsUserDto>> SyncUser([FromBody] AzureUserInfo model)
        {
            if (string.IsNullOrEmpty(model.ObjectId) && string.IsNullOrEmpty(model.UserPrincipalName))
            {
                return BadRequest("Azure user without ObjectId/UPN.");
            }

            Guid? oid = null;
            if (Guid.TryParse(model.ObjectId, out var parsed))
            {
                oid = parsed;
            }

            // Buscar por OID o UPN
            var user = await _db.Users.FirstOrDefaultAsync(u =>
                (oid != null && u.AZURE_OID == oid) ||
                (model.UserPrincipalName != null && u.AZURE_UPN == model.UserPrincipalName));

            if (user == null)
            {
                // Crear usuario nuevo
                user = new User
                {
                    USER_NAME = model.UserPrincipalName ?? model.Email ?? model.ObjectId ?? "unknown",
                    AZURE_OID = oid,
                    AZURE_UPN = model.UserPrincipalName,
                    EMAIL = model.Email ?? model.UserPrincipalName ?? "",
                    DISPLAY_NAME = model.DisplayName ?? model.UserPrincipalName ?? "",
                    IS_ACTIVE = true,
                    FIRST_NAME = "System",
                    LAST_NAME = "User",
                    PHONE_NUMBER = string.Empty,
                    TIME_ZONE = "UTC",
                    DATE_OF_BIRTH = DateTime.UtcNow,
                    RecordDate = DateTime.UtcNow,
                    CreateDate = DateTime.UtcNow,
                    RowPointer = Guid.NewGuid(),
                    CreatedBy = "SYSTEM-AAD",
                    UpdatedBy = "SYSTEM-AAD"
                };

                _db.Users.Add(user);
            }
            else
            {
                // Actualizar datos básicos
                user.EMAIL = model.Email ?? user.EMAIL;
                user.DISPLAY_NAME = model.DisplayName ?? user.DISPLAY_NAME;
                user.AZURE_UPN = model.UserPrincipalName ?? user.AZURE_UPN;
                user.AZURE_OID = oid ?? user.AZURE_OID;
                user.UpdatedBy = "SYSTEM-AAD";
            }

            await _db.SaveChangesAsync();

            // Traer roles del usuario
            var roles = await (from ur in _db.UserRoles
                               join r in _db.Roles on ur.RoleId equals r.ID_ROLE
                               where ur.UserId == user.ID_USER
                               select r.ROLE_NAME).ToListAsync();

            var dto = new CmsUserDto
            {
                Id = user.ID_USER,
                Username = user.USER_NAME,
                DisplayName = user.DISPLAY_NAME,
                Email = user.EMAIL,
                Roles = roles
            };

            return Ok(dto);
        }

        // =====================================================================
        // ⭐ NUEVO ENDPOINT: Generar JWT para el usuario
        // =====================================================================
        /// <summary>
        /// Genera un JWT para el usuario después del login de Azure AD en UI.
        /// El UI debe llamar este endpoint después de validar con Azure AD.
        /// </summary>
        [AllowAnonymous]
        [HttpPost("token")]
        public async Task<ActionResult<TokenResponseDto>> GenerateToken([FromBody] TokenRequestDto request)
        {
            try
            {
                _logger.LogInformation("🔑 Solicitud de token para: {Email}", request.Email);

                // Validar request
                if (string.IsNullOrEmpty(request.AzureOid))
                {
                    return BadRequest(new TokenResponseDto
                    {
                        Success = false,
                        Message = "Azure OID es requerido"
                    });
                }

                // Buscar usuario por Azure OID
                if (!Guid.TryParse(request.AzureOid, out var azureOid))
                {
                    return BadRequest(new TokenResponseDto
                    {
                        Success = false,
                        Message = "Azure OID inválido"
                    });
                }

                var user = await _db.Users
                    .Where(u => u.AZURE_OID == azureOid && u.IS_ACTIVE)
                    .FirstOrDefaultAsync();

                if (user == null)
                {
                    _logger.LogWarning("❌ Usuario no encontrado o inactivo: {AzureOid}", request.AzureOid);
                    return Unauthorized(new TokenResponseDto
                    {
                        Success = false,
                        Message = "Usuario no autorizado o inactivo"
                    });
                }

                // Calcular permisos del usuario
                var permissions = await _permissionService.GetUserPermissionsAsync(user.ID_USER);

                // ⭐ Obtener roles del usuario
                var roles = await (from ur in _db.UserRoles
                                   join r in _db.Roles on ur.RoleId equals r.ID_ROLE
                                   where ur.UserId == user.ID_USER
                                   select r.ROLE_NAME).ToListAsync();

                _logger.LogInformation("🔑 Token para {UserId}: {RoleCount} roles, {PermCount} permisos",
                    user.ID_USER, roles.Count, permissions.Count);

                // Generar token con roles
                var token = _jwtService.GenerateToken(
                    user.ID_USER,
                    user.USER_NAME,
                    user.EMAIL,
                    roles,
                    permissions.ToList()
                );

                var expiresIn = 3600; // 60 minutos
                var expiresAt = DateTime.UtcNow.AddSeconds(expiresIn);

                _logger.LogInformation("✅ Token generado exitosamente para: {UserName} ({UserId})",
                    user.USER_NAME, user.ID_USER);

                return Ok(new TokenResponseDto
                {
                    Success = true,
                    Token = token,
                    ExpiresIn = expiresIn,
                    ExpiresAt = expiresAt,
                    UserId = user.ID_USER,
                    UserName = user.USER_NAME
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "❌ Error generando token");
                return StatusCode(500, new TokenResponseDto
                {
                    Success = false,
                    Message = "Error interno del servidor"
                });
            }
        }

        // =====================================================================
        // ⭐ NUEVO ENDPOINT: Generar JWT para usuario local (email + password)
        // =====================================================================
        /// <summary>
        /// Genera un JWT para usuarios que se autentican con email/contraseña.
        /// El UI llama este endpoint después de validar credenciales localmente.
        /// </summary>
        [AllowAnonymous]
        [HttpPost("token/local")]
        public async Task<ActionResult<TokenResponseDto>> GenerateLocalToken([FromBody] LocalTokenRequestDto request)
        {
            try
            {
                _logger.LogInformation("🔑 Solicitud de token local para: {Email}", request.Email);

                // Validar request
                if (request.UserId <= 0)
                {
                    return BadRequest(new TokenResponseDto
                    {
                        Success = false,
                        Message = "UserId es requerido"
                    });
                }

                // Buscar usuario por ID
                var user = await _db.Users
                    .Where(u => u.ID_USER == request.UserId && u.IS_ACTIVE)
                    .FirstOrDefaultAsync();

                if (user == null)
                {
                    _logger.LogWarning("❌ Usuario no encontrado o inactivo: {UserId}", request.UserId);
                    return Unauthorized(new TokenResponseDto
                    {
                        Success = false,
                        Message = "Usuario no autorizado o inactivo"
                    });
                }

                // Verificar acceso a la compañía
                var hasAccess = await _db.UserCompanies
                    .AnyAsync(uc => 
                        uc.ID_USER == request.UserId && 
                        uc.ID_COMPANY == request.CompanyId && 
                        uc.IS_ACTIVE);

                if (!hasAccess)
                {
                    _logger.LogWarning("❌ Usuario {UserId} sin acceso a compañía {CompanyId}", 
                        request.UserId, request.CompanyId);
                    return Unauthorized(new TokenResponseDto
                    {
                        Success = false,
                        Message = "Usuario sin acceso a esta compañía"
                    });
                }

                // Calcular permisos del usuario
                var permissions = await _permissionService.GetUserPermissionsAsync(user.ID_USER);

                _logger.LogInformation("🔑 Permisos calculados: {Count} para usuario local {UserId}",
                    permissions.Count, user.ID_USER);

                // Generar token incluyendo el CompanyId
                var token = _jwtService.GenerateToken(
                    user.ID_USER,
                    user.USER_NAME,
                    user.EMAIL,
                    permissions.ToList(),
                    request.CompanyId
                );

                var expiresIn = 28800; // 8 horas para login local
                var expiresAt = DateTime.UtcNow.AddSeconds(expiresIn);

                _logger.LogInformation("✅ Token local generado para: {UserName} ({UserId}) en compañía {CompanyId}",
                    user.USER_NAME, user.ID_USER, request.CompanyId);

                return Ok(new TokenResponseDto
                {
                    Success = true,
                    Token = token,
                    ExpiresIn = expiresIn,
                    ExpiresAt = expiresAt,
                    UserId = user.ID_USER,
                    UserName = user.USER_NAME,
                    Message = "Token local generado exitosamente"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "❌ Error generando token local");
                return StatusCode(500, new TokenResponseDto
                {
                    Success = false,
                    Message = "Error interno del servidor"
                });
            }
        }
    }

    // =====================================================================
    // DTO para solicitud de token local
    // =====================================================================
    public class LocalTokenRequestDto
    {
        public int UserId { get; set; }
        public string Email { get; set; } = default!;
        public string DisplayName { get; set; } = default!;
        public int CompanyId { get; set; }
    }
}