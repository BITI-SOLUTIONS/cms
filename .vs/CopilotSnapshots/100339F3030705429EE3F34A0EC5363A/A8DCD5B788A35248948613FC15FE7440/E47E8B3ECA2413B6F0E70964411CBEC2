// ================================================================================
// ARCHIVO: CMS.API/Controllers/RoleController.cs
// PROPÓSITO: Endpoints para gestión de roles
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-14
// ================================================================================

using CMS.Data;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace CMS.API.Controllers
{
    [Authorize]
    [ApiController]
    [Route("api/[controller]")]
    public class RoleController : ControllerBase
    {
        private readonly AppDbContext _db;
        private readonly ILogger<RoleController> _logger;

        public RoleController(AppDbContext db, ILogger<RoleController> logger)
        {
            _db = db;
            _logger = logger;
        }

        /// <summary>
        /// Obtener todos los roles activos
        /// GET: api/role
        /// </summary>
        [HttpGet]
        public async Task<IActionResult> GetAll()
        {
            try
            {
                var roles = await _db.Roles
                    .Where(r => r.IS_ACTIVE)
                    .OrderBy(r => r.ROLE_NAME)
                    .Select(r => new RoleDto
                    {
                        Id = r.ID_ROLE,
                        RoleName = r.ROLE_NAME,
                        Description = r.DESCRIPTION,
                        IsSystem = r.IS_SYSTEM,
                        IsActive = r.IS_ACTIVE
                    })
                    .ToListAsync();

                _logger.LogInformation("📋 Roles obtenidos: {Count}", roles.Count);

                return Ok(roles);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo roles");
                return StatusCode(500, new { message = "Error obteniendo roles" });
            }
        }

        /// <summary>
        /// Obtener un rol por ID
        /// GET: api/role/{id}
        /// </summary>
        [HttpGet("{id}")]
        public async Task<IActionResult> GetById(int id)
        {
            try
            {
                var role = await _db.Roles
                    .Where(r => r.ID_ROLE == id)
                    .Select(r => new RoleDto
                    {
                        Id = r.ID_ROLE,
                        RoleName = r.ROLE_NAME,
                        Description = r.DESCRIPTION,
                        IsSystem = r.IS_SYSTEM,
                        IsActive = r.IS_ACTIVE
                    })
                    .FirstOrDefaultAsync();

                if (role == null)
                    return NotFound(new { message = "Rol no encontrado" });

                return Ok(role);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo rol {Id}", id);
                return StatusCode(500, new { message = "Error obteniendo rol" });
            }
        }

        /// <summary>
        /// Obtener permisos de un rol
        /// GET: api/role/{id}/permissions
        /// </summary>
        [HttpGet("{id}/permissions")]
        public async Task<IActionResult> GetRolePermissions(int id)
        {
            try
            {
                var permissions = await (from rp in _db.RolePermissions
                                         join p in _db.Permissions on rp.PermissionId equals p.ID_PERMISSION
                                         where rp.RoleId == id
                                         select new PermissionDto
                                         {
                                             Id = p.ID_PERMISSION,
                                             PermissionKey = p.PERMISSION_KEY,
                                             PermissionName = p.PERMISSION_NAME,
                                             IsAllowed = rp.IsAllowed
                                         }).ToListAsync();

                return Ok(permissions);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error obteniendo permisos del rol {Id}", id);
                return StatusCode(500, new { message = "Error obteniendo permisos" });
            }
        }

        public class RoleDto
        {
            public int Id { get; set; }
            public string RoleName { get; set; } = string.Empty;
            public string? Description { get; set; }
            public bool IsSystem { get; set; }
            public bool IsActive { get; set; }
        }

        public class PermissionDto
        {
            public int Id { get; set; }
            public string PermissionKey { get; set; } = string.Empty;
            public string PermissionName { get; set; } = string.Empty;
            public bool IsAllowed { get; set; }
        }
    }
}
