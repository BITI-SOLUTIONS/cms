// ================================================================================
// ARCHIVO: CMS.UI/Services/TokenApiService.cs
// PROPÓSITO: Servicio para obtener JWT del API después del login de Azure AD
// AUTOR: EAMR, BITI SOLUTIONS S.A
// CREADO: 2026-02-11
// ================================================================================

using CMS.Application.DTOs;
using System.Net.Http.Json;

namespace CMS.UI.Services
{
    /// <summary>
    /// Servicio para obtener token JWT del API después del login de Azure AD.
    /// El UI usa este token para autenticarse en todas las llamadas al API.
    /// </summary>
    public class TokenApiService
    {
        private readonly IHttpClientFactory _httpClientFactory;
        private readonly ILogger<TokenApiService> _logger;

        public TokenApiService(IHttpClientFactory httpClientFactory, ILogger<TokenApiService> logger)
        {
            _httpClientFactory = httpClientFactory;
            _logger = logger;
        }

        /// <summary>
        /// Obtiene un JWT del API usando los datos del usuario de Azure AD.
        /// </summary>
        /// <param name="azureUser">Información del usuario autenticado en Azure AD</param>
        /// <param name="companyId">ID de la compañía seleccionada</param>
        /// <returns>TokenResponseDto con el JWT y datos del usuario</returns>
        public async Task<TokenResponseDto?> GetApiTokenAsync(UserSyncApiService.AzureUserInfo azureUser, int companyId)
        {
            try
            {
                _logger.LogInformation("🔑 Solicitando JWT para: {Email} en compañía {CompanyId}", azureUser.Email, companyId);

                // Crear request para el API
                var tokenRequest = new TokenRequestDto
                {
                    AzureOid = azureUser.ObjectId ?? string.Empty,
                    Email = azureUser.Email ?? string.Empty,
                    DisplayName = azureUser.DisplayName ?? string.Empty,
                    CompanyId = companyId
                };

                // Llamar al API (sin autenticación, endpoint público)
                var httpClient = _httpClientFactory.CreateClient("cmsapi");
                var response = await httpClient.PostAsJsonAsync("/api/auth/token", tokenRequest);

                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    _logger.LogWarning("❌ Error obteniendo token: {StatusCode} - {Error}", 
                        response.StatusCode, errorContent);
                    return null;
                }

                var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponseDto>();

                if (tokenResponse?.Success == true)
                {
                    _logger.LogInformation("✅ JWT obtenido: UserId={UserId}, Expira={Expiry}", 
                        tokenResponse.UserId, tokenResponse.ExpiresAt);
                }
                else
                {
                    _logger.LogWarning("⚠️ Respuesta sin éxito: {Message}", tokenResponse?.Message);
                }

                return tokenResponse;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "❌ Excepción al obtener token");
                return null;
            }
        }

        /// <summary>
        /// Verifica si un token ha expirado.
        /// </summary>
        public bool IsTokenExpired(string expiryDateString)
        {
            if (string.IsNullOrEmpty(expiryDateString))
                return true;

            if (DateTime.TryParse(expiryDateString, out var expiryDate))
            {
                return DateTime.UtcNow >= expiryDate;
            }

            return true;
        }

        /// <summary>
        /// Obtiene un JWT del API para un usuario local (email + contraseña).
        /// </summary>
        public async Task<TokenResponseDto?> GetApiTokenForLocalUserAsync(CMS.Entities.User user, int companyId)
        {
            try
            {
                _logger.LogInformation("🔑 Solicitando JWT para usuario local: {Email}", user.EMAIL);

                var tokenRequest = new LocalTokenRequestDto
                {
                    UserId = user.ID_USER,
                    Email = user.EMAIL,
                    DisplayName = user.DISPLAY_NAME,
                    CompanyId = companyId
                };

                var httpClient = _httpClientFactory.CreateClient("cmsapi");
                var response = await httpClient.PostAsJsonAsync("/api/auth/token/local", tokenRequest);

                if (!response.IsSuccessStatusCode)
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    _logger.LogWarning("❌ Error obteniendo token local: {StatusCode} - {Error}",
                        response.StatusCode, errorContent);
                    return null;
                }

                var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponseDto>();

                if (tokenResponse?.Success == true)
                {
                    _logger.LogInformation("✅ JWT local obtenido: UserId={UserId}, Expira={Expiry}",
                        tokenResponse.UserId, tokenResponse.ExpiresAt);
                }

                return tokenResponse;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "❌ Excepción al obtener token local");
                return null;
            }
        }
    }

    /// <summary>
    /// DTO para solicitar token de usuario local
    /// </summary>
    public class LocalTokenRequestDto
    {
        public int UserId { get; set; }
        public string Email { get; set; } = default!;
        public string DisplayName { get; set; } = default!;
        public int CompanyId { get; set; }
    }
}